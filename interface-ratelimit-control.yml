
- name: Reboot to Defaults. Run {{ansible_loop.index}} of {{ansible_loop.length}}
  reboot:
  become: yes
  tags: discover

- name: Set Static Controls
  include_tasks: static-controls.yml

- name: Set Variable Factor Controls
  include_tasks: variable-controls.yml

- name: Copy Performance Monitor
  copy:
    src: gather_stats.bash
    dest: "{{sensor_dir}}/gather_stats.bash"
    mode: '0755'

  #-run replicates
- name: Begin Interface Ratelimit Benchmark
  include_tasks: interface-ratelimit-tasks.yml
  loop: "{{ replicates }}"
  loop_control:
    extended: yes
    loop_var: inner_counter
    index_var: inner_idx
  tags: discover


- name: End of Run ANOVA Test
  local_action:
    module: shell
    _raw_params: |
        python anova.py 'results/{{ inventory_hostname }}-{{capture_driver}}-ksoftirqd0-results-run{{test_counter}}.csv' nicdrop "{{total_factors}}" "{{replicates|length}}" 0.05
  register: anova
  tags: anova
  when: "ansible_loop.revindex == 1 and test_counter > 1"
  changed_when: false
  ignore_errors: yes


- name: Update Last Loop Best
  set_fact:
   last_loop_best: "{{anova.stdout_lines[anova.stdout_lines|length -3]|int}}"
   #discovered_pps_limit: "{{pps_limit|int - target_to_beat}}"
   #cacheable: yes


- debug:
    msg: "Last Loops Best: {{last_loop_best}}"
